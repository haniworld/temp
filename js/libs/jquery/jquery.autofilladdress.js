// Generated by CoffeeScript 1.7.1
(function($) {
  $.fn.autofilladdress = function(options) {
    var callback, currentValue, elements, fill, getAddress, getZip, handle, update;
    if (typeof options === 'function') {
      callback = options;
    } else {
      options = $.extend(true, {}, $.autofilladdress.defaults, options);
      callback = options.callback;
    }
    elements = this;
    currentValue = '';
    getZip = function() {
      var zip = '';
      elements.each(function(index, element) {
        zip += $(this).val();
        return true;
      });
      return zip;
    };
    handle = function() {
      var newValue;
      newValue = getZip();
      if (newValue === currentValue || newValue.length < 7) {
        return;
      }
      currentValue = newValue;
      return update();
    };
    update = function() {
      var zip;
      zip = getZip();
      callback = function(prefectureId, prefecture, municipality, subarea) {
        if (options.focusOnSuccess) {
          $(options.focusOnSuccess).focus();
        }
        return fill(prefectureId, prefecture, municipality, subarea);
      };
      return getAddress(zip, callback);
    };
    getAddress = function(zipcode, callback) {
      var url, zipcodePrefix;
      if (typeof zipcode === 'number') {
        zipcode = String(zipcode);
      }
      zipcode = $.trim(zipcode.replace('-', ''));
      zipcodePrefix = zipcode.substr(0, 3);
      url = options.path.replace('###', zipcodePrefix);
      return $.ajax(url, {
        dataType: 'json',
        success: function(data, textStatus, jqXHR) {
          var locationData, municipality, prefecture, prefectureId, subarea;
          locationData = data[zipcode];
          if (!locationData) {
            return;
          }
          prefectureId = locationData[0];
          prefecture = options.prefectures[prefectureId];
          municipality = locationData[1];
          subarea = locationData[2];
          if (callback) {
            return callback.call(null, prefectureId, prefecture, municipality, subarea);
          }
        }
      });
    };
    fill = function(prefectureId, prefecture, municipality, subarea) {
      if (!options.fill) {
        return;
      }
      if (options.fill.prefecture && $(options.fill.prefecture).length > 0) {
        if ($(options.fill.prefecture).find('option[value=' + prefectureId + ']').length > 0) {
          $(options.fill.prefecture).val(prefectureId);
        } else {
          $(options.fill.prefecture).val(prefecture);
        }
      }
      if (options.fill.municipality && $(options.fill.municipality).length > 0) {
        $(options.fill.municipality).val(municipality);
      }
      if (options.fill.subarea && (options.fill.subarea !== options.fill.municipality) && $(options.fill.subarea).length > 0) {
        return $(options.fill.subarea).val(subarea);
      } else if (options.fill.municipality === options.fill.subarea) {
        return $(options.fill.municipality).val(municipality + subarea);
      }
    };
    currentValue = getZip();
    this.on('keyup blur', handle);
    if (options.auto) {
      return update();
    }
  };
  $.autofilladdress = {
    defaults: {
      path: '###.json',
      prefectures: {
        1: '北海道',
        2: '青森県',
        3: '岩手県',
        4: '宮城県',
        5: '秋田県',
        6: '山形県',
        7: '福島県',
        8: '茨城県',
        9: '栃木県',
        10: '群馬県',
        11: '埼玉県',
        12: '千葉県',
        13: '東京都',
        14: '神奈川県',
        15: '新潟県',
        16: '富山県',
        17: '石川県',
        18: '福井県',
        19: '山梨県',
        20: '長野県',
        21: '岐阜県',
        22: '静岡県',
        23: '愛知県',
        24: '三重県',
        25: '滋賀県',
        26: '京都府',
        27: '大阪府',
        28: '兵庫県',
        29: '奈良県',
        30: '和歌山県',
        31: '鳥取県',
        32: '島根県',
        33: '岡山県',
        34: '広島県',
        35: '山口県',
        36: '徳島県',
        37: '香川県',
        38: '愛媛県',
        39: '高知県',
        40: '福岡県',
        41: '佐賀県',
        42: '長崎県',
        43: '熊本県',
        44: '大分県',
        45: '宮崎県',
        46: '鹿児島県',
        47: '沖縄県'
      }
    }
  };
  if (typeof define === 'function') {
    return define('jquery.autofilladdress', ['jquery'], function() {
      return $;
    });
  }
}).call(this, jQuery);
